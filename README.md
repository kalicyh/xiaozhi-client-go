# å°æ™ºå®¢æˆ·ç«¯ Go ç‰ˆæœ¬

åŸºäº Wails v2 å¼€å‘çš„è·¨å¹³å°å°æ™ºè¯­éŸ³åŠ©æ‰‹å®¢æˆ·ç«¯ï¼Œæ”¯æŒ WebSocket å’Œ MQTT+UDP åŒåè®®é€šä¿¡ã€‚

## ğŸš€ åŠŸèƒ½ç‰¹æ€§

### ğŸ“¡ åŒåè®®æ”¯æŒ
- **WebSocket åè®®**ï¼šç®€å•ç›´æ¥çš„å…¨åŒå·¥é€šä¿¡
- **MQTT+UDP åè®®ï¼ˆæœªå®Œæˆï¼‰**ï¼šæ§åˆ¶æ¶ˆæ¯ä¸éŸ³é¢‘æ•°æ®åˆ†ç¦»ï¼Œæ›´é«˜çš„å®æ—¶æ€§

### ğŸ” çµæ´»çš„èº«ä»½éªŒè¯
- **Header æ–¹å¼**ï¼šé€šè¿‡ `Authorization` å¤´æºå¸¦ Bearer Token
- **Query å‚æ•°**ï¼šé€šè¿‡ `access_token` æˆ– `token` å‚æ•°æºå¸¦
- **æ‰‹åŠ¨é€‰æ‹©**ï¼šç”¨æˆ·å¯åœ¨ç•Œé¢ä¸­è‡ªç”±åˆ‡æ¢è®¤è¯æ–¹å¼

### ğŸµ éŸ³é¢‘å¤„ç†
- **Opus ç¼–ç **ï¼šé«˜è´¨é‡ä½å»¶è¿Ÿçš„éŸ³é¢‘å‹ç¼©
- **å®æ—¶ä¼ è¾“**ï¼šæ”¯æŒå®æ—¶è¯­éŸ³è¾“å…¥è¾“å‡º
- **å¤šåè®®ç‰ˆæœ¬ï¼ˆæœªå®Œæˆï¼‰**ï¼šæ”¯æŒä¸åŒçš„äºŒè¿›åˆ¶åè®®æ ¼å¼

### ğŸ› ï¸ è®¾å¤‡ç®¡ç†
- **OTA è‡ªåŠ¨è·å–**ï¼šæ”¯æŒä»æœåŠ¡å™¨è‡ªåŠ¨è·å– WebSocket è¿æ¥ä¿¡æ¯
- **é…ç½®æŒä¹…åŒ–**ï¼šSQLite æ•°æ®åº“å­˜å‚¨è¿æ¥é…ç½®
- **è®¾å¤‡æ ‡è¯†**ï¼šç»Ÿä¸€çš„è®¾å¤‡ ID ç®¡ç†

### ğŸ–¥ï¸ å“åº”å¼ç•Œé¢
- **çª—å£çŠ¶æ€æ£€æµ‹**ï¼šè‡ªåŠ¨æ£€æµ‹å…¨å±/å¤§çª—å£çŠ¶æ€
- **åŠ¨æ€ç¼©æ”¾**ï¼šç•Œé¢å…ƒç´ æ ¹æ®çª—å£å¤§å°è‡ªåŠ¨ç¼©æ”¾
- **å®æ—¶çŠ¶æ€**ï¼šè¿æ¥çŠ¶æ€ã€å½•éŸ³çŠ¶æ€çš„å®æ—¶æ˜¾ç¤º

## ğŸ—ï¸ æŠ€æœ¯æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   React å‰ç«¯    â”‚    â”‚   Wails æ¡¥æ¥    â”‚    â”‚    Go åç«¯      â”‚
â”‚                 â”‚    â”‚                 â”‚    â”‚                 â”‚
â”‚ - ç”¨æˆ·ç•Œé¢      â”‚â—„â”€â”€â–ºâ”‚ - JS/Go é€šä¿¡    â”‚â—„â”€â”€â–ºâ”‚ - WebSocket     â”‚
â”‚ - é…ç½®ç®¡ç†      â”‚    â”‚ - äº‹ä»¶ä¼ é€’      â”‚    â”‚ - MQTT å®¢æˆ·ç«¯   â”‚
â”‚ - çŠ¶æ€æ˜¾ç¤º      â”‚    â”‚ - çª—å£æ§åˆ¶      â”‚    â”‚ - éŸ³é¢‘å¤„ç†      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                       â”‚
                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚                        â”‚                        â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   WebSocket ä¼ è¾“  â”‚   â”‚   MQTT æ§åˆ¶é€šé“   â”‚   â”‚   UDP éŸ³é¢‘é€šé“    â”‚
                    â”‚                   â”‚   â”‚                   â”‚   â”‚                   â”‚
                    â”‚ - å…¨åŒå·¥é€šä¿¡      â”‚   â”‚ - æ§åˆ¶æ¶ˆæ¯        â”‚   â”‚ - å®æ—¶éŸ³é¢‘        â”‚
                    â”‚ - JSON + äºŒè¿›åˆ¶   â”‚   â”‚ - çŠ¶æ€åŒæ­¥        â”‚   â”‚ - åŠ å¯†ä¼ è¾“        â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“¦ é¡¹ç›®ç»“æ„

```
xiaozhi-client-go/
â”œâ”€â”€ app.go                     # ä¸»åº”ç”¨å…¥å£ï¼ŒWails ç»‘å®š
â”œâ”€â”€ main.go                    # ç¨‹åºå…¥å£ç‚¹
â”œâ”€â”€ go.mod                     # Go æ¨¡å—å®šä¹‰
â”œâ”€â”€ wails.json                 # Wails é¡¹ç›®é…ç½®
â”œâ”€â”€ 
â”œâ”€â”€ frontend/                  # React å‰ç«¯
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ App.jsx           # ä¸»ç•Œé¢ç»„ä»¶
â”‚   â”‚   â”œâ”€â”€ App.css           # æ ·å¼æ–‡ä»¶ï¼ŒåŒ…å«å“åº”å¼è®¾è®¡
â”‚   â”‚   â””â”€â”€ main.jsx          # React å…¥å£
â”‚   â”œâ”€â”€ package.json          # å‰ç«¯ä¾èµ–
â”‚   â””â”€â”€ index.html            # HTML æ¨¡æ¿
â”œâ”€â”€ 
â”œâ”€â”€ internal/                  # å†…éƒ¨æ¨¡å—
â”‚   â”œâ”€â”€ client/               # å®¢æˆ·ç«¯æ ¸å¿ƒ
â”‚   â”‚   â”œâ”€â”€ client.go         # ä¸»å®¢æˆ·ç«¯å®ç°
â”‚   â”‚   â”œâ”€â”€ config.go         # é…ç½®ç»“æ„ä½“
â”‚   â”‚   â””â”€â”€ types.go          # æ¶ˆæ¯ç±»å‹å®šä¹‰
â”‚   â”‚   
â”‚   â”œâ”€â”€ transport/            # ä¼ è¾“å±‚å®ç°
â”‚   â”‚   â”œâ”€â”€ websocket.go      # WebSocket ä¼ è¾“
â”‚   â”‚   â”œâ”€â”€ mqtt.go          # MQTT æ§åˆ¶é€šé“
â”‚   â”‚   â””â”€â”€ udp_audio.go     # UDP éŸ³é¢‘é€šé“
â”‚   â”‚   
â”‚   â”œâ”€â”€ store/               # æ•°æ®å­˜å‚¨
â”‚   â”‚   â”œâ”€â”€ sqlite.go        # SQLite æ•°æ®åº“
â”‚   â”‚   â””â”€â”€ config_store.go  # é…ç½®æŒä¹…åŒ–
â”‚   â”‚   
â”‚   â””â”€â”€ audio/               # éŸ³é¢‘å¤„ç†
â”‚       â””â”€â”€ capture/         # éŸ³é¢‘é‡‡é›†
â”œâ”€â”€ 
â”œâ”€â”€ docs/                     # åè®®æ–‡æ¡£
â”‚   â”œâ”€â”€ websocket.md         # WebSocket åè®®è§„èŒƒ
â”‚   â””â”€â”€ mqtt-udp.md          # MQTT+UDP åè®®è§„èŒƒ
â”œâ”€â”€ 
â””â”€â”€ build/                    # æ„å»ºé…ç½®
    â”œâ”€â”€ windows/             # Windows å¹³å°é…ç½®
    â”œâ”€â”€ darwin/              # macOS å¹³å°é…ç½®
    â””â”€â”€ appicon.png          # åº”ç”¨å›¾æ ‡
```

## ğŸ› ï¸ å¼€å‘ç¯å¢ƒ

### å‰ç½®è¦æ±‚

- **Go 1.23+**ï¼šåç«¯å¼€å‘è¯­è¨€
- **Node.js 16+**ï¼šå‰ç«¯å¼€å‘ç¯å¢ƒ
- **Wails CLI v2.10.2+**ï¼šæ¡Œé¢åº”ç”¨æ¡†æ¶

### å®‰è£… Wails CLI

```bash
# å®‰è£… Wails CLI
go install github.com/wailsapp/wails/v2/cmd/wails@latest

# éªŒè¯å®‰è£…
wails doctor
```

### å…‹éš†é¡¹ç›®

```bash
git clone https://github.com/kalicyh/xiaozhi-client-go.git
cd xiaozhi-client-go
```

### å®‰è£…ä¾èµ–

```bash
# å®‰è£…å‰ç«¯ä¾èµ–
cd frontend
npm install
cd ..

# ä¸‹è½½ Go ä¾èµ–
go mod tidy
```

## ğŸš€ è¿è¡Œé¡¹ç›®

### å¼€å‘æ¨¡å¼

```bash
# å¯åŠ¨å¼€å‘æœåŠ¡å™¨ï¼ˆçƒ­é‡è½½ï¼‰
wails dev
```

å¼€å‘æœåŠ¡å™¨ä¼šè‡ªåŠ¨ï¼š
- å¯åŠ¨ Go åç«¯
- å¯åŠ¨ Vite å‰ç«¯å¼€å‘æœåŠ¡å™¨
- æ‰“å¼€æ¡Œé¢åº”ç”¨çª—å£
- æä¾›æµè§ˆå™¨è®¿é—®åœ°å€ï¼ˆé€šå¸¸æ˜¯ http://localhost:34115ï¼‰

### ç”Ÿäº§æ„å»º

```bash
# æ„å»ºç”Ÿäº§ç‰ˆæœ¬
wails build

# æ„å»ºç»“æœä½äº build/bin/ ç›®å½•
```

### æ„å»ºé€‰é¡¹

```bash
# ä»…æ„å»ºï¼Œä¸æ‰“åŒ…
wails build -clean

# è·³è¿‡å‰ç«¯æ„å»ºï¼ˆå‰ç«¯å·²æ„å»ºï¼‰
wails build -s

# æ„å»ºå¹¶å‹ç¼©
wails build -upx
```

## ğŸ“‹ ä½¿ç”¨è¯´æ˜

### åŸºæœ¬é…ç½®

1. **é€‰æ‹©åè®®**ï¼šåœ¨ç•Œé¢ä¸Šé€‰æ‹© "WebSocket" æˆ– "MQTT + UDP"
2. **é…ç½®è¿æ¥**ï¼š
   - WebSocketï¼šå¯ä½¿ç”¨ OTA è‡ªåŠ¨è·å–æˆ–æ‰‹åŠ¨è¾“å…¥ URL
   - MQTTï¼šé…ç½® Broker åœ°å€ã€ä¸»é¢˜ç­‰ä¿¡æ¯
3. **è®¾ç½®è®¤è¯**ï¼š
   - å¯ç”¨/ç¦ç”¨ Token è®¤è¯
   - é€‰æ‹© Token æºå¸¦æ–¹å¼ï¼ˆHeader/Queryå‚æ•°ï¼‰
4. **ç‚¹å‡»è¿æ¥**ï¼šå»ºç«‹ä¸æœåŠ¡å™¨çš„è¿æ¥

### OTA è‡ªåŠ¨é…ç½®

å½“ä½¿ç”¨ WebSocket åè®®ä¸”å¯ç”¨ OTA æ—¶ï¼š

1. é…ç½® OTA URLï¼ˆé»˜è®¤ï¼š`https://api.tenclass.net/xiaozhi/ota/`ï¼‰
2. ç¼–è¾‘ POST è¯·æ±‚ä½“ï¼ˆJSON æ ¼å¼ï¼‰ï¼ŒåŒ…å«è®¾å¤‡ä¿¡æ¯
3. å®¢æˆ·ç«¯ä¼šè‡ªåŠ¨è¯·æ±‚æœåŠ¡å™¨è·å– WebSocket è¿æ¥ä¿¡æ¯

### Token è®¤è¯æ–¹å¼

- **Header Authorization**ï¼š`Authorization: Bearer <token>`
- **Queryå‚æ•° access_token**ï¼š`wss://host/ws?access_token=<token>`
- **Queryå‚æ•° token**ï¼š`wss://host/ws?token=<token>`

### ç•Œé¢è‡ªé€‚åº”

åº”ç”¨æ”¯æŒå“åº”å¼è®¾è®¡ï¼š
- **æ™®é€šçª—å£**ï¼šæ ‡å‡†ç•Œé¢å¸ƒå±€
- **å¤§çª—å£**ï¼ˆâ‰¥1200px å®½ï¼‰ï¼šç•Œé¢å…ƒç´ æŒ‰æ¯”ä¾‹æ”¾å¤§ 1.2 å€
- **å…¨å±æ¨¡å¼**ï¼šç•Œé¢å…ƒç´ æŒ‰æ¯”ä¾‹æ”¾å¤§ 1.5 å€

## ğŸ”§ é…ç½®è¯´æ˜

### è¿æ¥é…ç½®

```go
type Config struct {
    // åè®®ç‰ˆæœ¬
    ProtocolVersion int    `json:"protocol_version"`
    
    // WebSocket é…ç½®
    WebsocketURL string   `json:"websocket_url"`
    UseOTA       bool     `json:"use_ota"`
    OTAURL       string   `json:"ota_url"`
    OTABody      string   `json:"ota_body"`
    
    // è®¤è¯é…ç½®
    EnableToken bool      `json:"enable_token"`
    AuthToken   string    `json:"auth_token"`
    TokenMethod string    `json:"token_method"` // "header", "query_access_token", "query_token"
    
    // è®¾å¤‡æ ‡è¯†
    DeviceID    string    `json:"device_id"`
    ClientID    string    `json:"client_id"`
    
    // MQTT é…ç½®
    MQTTBroker        string `json:"mqtt_broker"`
    MQTTUsername      string `json:"mqtt_username"`
    MQTTPassword      string `json:"mqtt_password"`
    MQTTPublishTopic  string `json:"mqtt_publish_topic"`
    MQTTSubscribeTopic string `json:"mqtt_subscribe_topic"`
    
    // éŸ³é¢‘é…ç½®
    Audio AudioParams `json:"audio"`
    
    // è¶…æ—¶é…ç½®
    HelloTimeout time.Duration `json:"hello_timeout"`
}
```

### éŸ³é¢‘å‚æ•°

```go
type AudioParams struct {
    Format        string `json:"format"`         // "opus"
    SampleRate    int    `json:"sample_rate"`    // 16000
    Channels      int    `json:"channels"`       // 1
    FrameDuration int    `json:"frame_duration"` // 60 (ms)
}
```

## ğŸ“– åè®®æ–‡æ¡£

è¯¦ç»†çš„é€šä¿¡åè®®è¯·å‚è€ƒï¼š

- [WebSocket åè®®è§„èŒƒ](docs/websocket.md) - å®Œæ•´çš„ WebSocket é€šä¿¡åè®®æ–‡æ¡£
- [MQTT+UDP åè®®è§„èŒƒ](docs/mqtt-udp.md) - MQTT æ§åˆ¶ + UDP éŸ³é¢‘çš„æ··åˆåè®®

## ğŸ” æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **Wails CLI æœªæ‰¾åˆ°**
   ```bash
   # ç¡®ä¿ Go bin ç›®å½•åœ¨ PATH ä¸­
   go env GOPATH
   export PATH=$PATH:$(go env GOPATH)/bin
   ```

2. **å‰ç«¯æ„å»ºå¤±è´¥**
   ```bash
   # æ¸…ç†å¹¶é‡æ–°å®‰è£…ä¾èµ–
   cd frontend
   rm -rf node_modules package-lock.json
   npm install
   ```

3. **Go æ¨¡å—ä¸‹è½½å¤±è´¥**
   ```bash
   # è®¾ç½®ä»£ç†ï¼ˆä¸­å›½å¤§é™†ï¼‰
   go env -w GOPROXY=https://goproxy.cn,direct
   go mod tidy
   ```

4. **è¿æ¥æœåŠ¡å™¨å¤±è´¥**
   - æ£€æŸ¥ç½‘ç»œè¿æ¥
   - éªŒè¯æœåŠ¡å™¨åœ°å€å’Œç«¯å£
   - ç¡®è®¤ Token æœ‰æ•ˆæ€§
   - æŸ¥çœ‹æ§åˆ¶å°é”™è¯¯ä¿¡æ¯

### è°ƒè¯•æ¨¡å¼

å¼€å‘æ¨¡å¼ä¸‹ï¼Œåº”ç”¨ä¼šè¾“å‡ºè¯¦ç»†çš„è°ƒè¯•ä¿¡æ¯ï¼š

```bash
# æŸ¥çœ‹è¿æ¥è¿‡ç¨‹
ws open: url=wss://host/ws?access_token=***; headers=map[...]; token=query:access_token

# æŸ¥çœ‹æ¡æ‰‹æ¶ˆæ¯
ws hello payload={"type":"hello","version":1,...}
```

## ğŸ¤ è´¡çŒ®æŒ‡å—

1. Fork æœ¬ä»“åº“
2. åˆ›å»ºç‰¹æ€§åˆ†æ”¯ï¼š`git checkout -b feature/amazing-feature`
3. æäº¤æ›´æ”¹ï¼š`git commit -m 'Add amazing feature'`
4. æ¨é€åˆ†æ”¯ï¼š`git push origin feature/amazing-feature`
5. æäº¤ Pull Request

## ğŸ“„ è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨ MIT è®¸å¯è¯ - æŸ¥çœ‹ [LICENSE](LICENSE) æ–‡ä»¶äº†è§£è¯¦æƒ…ã€‚

## ğŸ™ è‡´è°¢

- [Wails](https://wails.io/) - ä¼˜ç§€çš„ Go + Web å‰ç«¯æ¡†æ¶
- [React](https://reactjs.org/) - ç”¨æˆ·ç•Œé¢æ„å»ºåº“
- [Vite](https://vitejs.dev/) - å¿«é€Ÿçš„å‰ç«¯æ„å»ºå·¥å…·
- [Gorilla WebSocket](https://github.com/gorilla/websocket) - Go WebSocket å®ç°
- [Eclipse Paho MQTT](https://github.com/eclipse/paho.mqtt.golang) - Go MQTT å®¢æˆ·ç«¯

---

**å°æ™ºå®¢æˆ·ç«¯** - è®©è¯­éŸ³äº¤äº’æ›´ç®€å• ğŸ™ï¸âœ¨
